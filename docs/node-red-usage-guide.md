# Node-RED 使い方ガイド

Node-REDの基本的な操作方法について説明します。

## フローの削除

### ノードの削除

1. 削除したいノードをクリックして選択（赤枠が表示される）
2. `Delete`キー（または`Backspace`）を押す
3. または右クリック → 「Delete」を選択

**複数ノードの削除:**
- `Ctrl+A`ですべて選択
- または`Ctrl+クリック`で複数選択
- `Delete`キーで削除

### フロータブの削除

1. 削除したいフロータブを右クリック
2. 「フローを削除」を選択
3. 確認ダイアログでOK

**重要な制限:**
- **最後の1つのフロータブは削除できません**
- 削除したい場合は、先に新しいフローを追加してから削除してください

### すべてをリセット

すべてのフローとデータを削除して新規状態に戻す場合：

```bash
./scripts/reset.sh
```

**警告:** すべてのフロー、設定、カスタムノードが削除されます。

## デプロイ

### デプロイとは

デプロイは、編集したフローを**保存して実行可能な状態にする**操作です。

### デプロイ前後の違い

| 状態 | flows.json | ブラウザメモリ | ランタイム |
|------|-----------|--------------|-----------|
| フロー作成/編集中 | 変更なし | ✓ 変更あり | 変更なし |
| デプロイ実行後 | ✓ 更新 | ✓ 変更あり | ✓ 実行開始 |

**重要:** フローを編集しただけでは保存されません。デプロイして初めて永続化されます。

### デプロイの種類

デプロイボタンの横にある**▼**をクリックすると、3つのオプションが選択できます：

#### 1. Modified Nodes（変更されたノードのみ）

```
影響範囲: 変更されたノードのみ
使用シーン: 小さな修正、デバッグ中
```

- 最も影響範囲が小さい
- 変更されたノードだけを再起動
- 他のノードは実行を継続

#### 2. Modified Flows（変更されたフローのみ）

```
影響範囲: 変更されたフロータブ全体
使用シーン: フロー単位での開発（推奨）
```

- 変更があったフロータブ全体を再デプロイ
- そのフロー内のすべてのノードが再起動
- 他のフローは影響を受けない

#### 3. Full（完全デプロイ）

```
影響範囲: すべてのフロー
使用シーン: 大きな変更、設定変更後
```

- すべてのフローを再デプロイ
- Node-REDランタイム全体が再起動

### デプロイ時のファイル変更

デプロイを実行すると、`docker/data/`以下のファイルが更新されます：

```
flows.json          ← 新しい内容で更新
.flows.json.backup  ← 前回のflows.jsonがバックアップとして保存
flows_cred.json     ← クレデンシャル情報が更新（必要な場合）
```

### デプロイのベストプラクティス

1. **こまめにデプロイ**
   - 大きな変更をする前にデプロイ
   - バックアップが作成されるため、問題時に復旧しやすい

2. **適切なデプロイタイプを選択**
   - 通常は「Modified Flows」を使用
   - 小さな変更なら「Modified Nodes」
   - 設定変更後は「Full」

3. **デプロイ前に確認**
   - 赤い「Deploy」ボタンは未保存の変更があることを示す
   - デプロイ前に変更内容を確認

## Node-REDプロジェクト機能

### 概要

Node-REDのフローを**Git統合されたプロジェクト**として管理する機能です。

### 主な機能

| 機能 | 説明 |
|------|------|
| **Gitバージョン管理** | UI内からコミット、プッシュ、プル、ブランチ操作 |
| **複数プロジェクト管理** | プロジェクトの作成・切り替えが可能 |
| **依存関係管理** | `package.json`でカスタムノードを管理 |
| **チーム開発** | リモートリポジトリとの連携 |

### プロジェクト構造

```
data/projects/<project-name>/
├── flows.json          # フロー定義
├── package.json        # 依存ノード
├── settings.json       # プロジェクト設定
├── README.md           # ドキュメント
└── .git/               # Gitリポジトリ
```

### プロジェクト機能 vs 通常モード

| 項目 | 通常モード | プロジェクト機能 |
|------|-----------|---------------|
| フロー保存 | `data/flows.json` | `data/projects/<name>/` |
| Git統合 | なし | あり（UI内蔵） |
| 複数管理 | 1つのみ | 複数可能 |
| 依存管理 | 手動 | `package.json` |
| 学習曲線 | 簡単 | やや複雑 |

### 有効化方法

#### 現在の設定

```yaml
# docker/docker-compose.yml
environment:
  - NODE_RED_ENABLE_PROJECTS=false  # 無効
```

#### 有効化手順

1. `docker/env.example`を`docker/.env`にコピー：
   ```bash
   cp docker/env.example docker/.env
   ```

2. `.env`ファイルに追加：
   ```bash
   NODE_RED_ENABLE_PROJECTS=true
   ```

3. `docker-compose.yml`を環境変数対応に変更（オプション）：
   ```yaml
   environment:
     - NODE_RED_ENABLE_PROJECTS=${NODE_RED_ENABLE_PROJECTS:-false}
   ```

4. コンテナを再起動：
   ```bash
   ./scripts/stop.sh
   ./scripts/start.sh
   ```

5. Node-REDにアクセスすると、プロジェクトセットアップウィザードが表示される

### 使用シーン

#### プロジェクト機能が適している場合

- ✅ チームでの共同開発
- ✅ 本番環境への展開
- ✅ バージョン管理が必要
- ✅ 複数プロジェクトの並行開発

#### 通常モードが適している場合

- ✅ 個人での学習・実験（**この学習環境の目的**）
- ✅ シンプルなユースケース
- ✅ 素早くフローを試したい
- ✅ Gitの知識が不要

### 推奨設定

**この学習環境では通常モード（無効）を推奨**

理由：
- シンプルで直感的
- Node-REDの学習に集中できる
- Git操作の知識が不要
- 自由に実験・削除できる

将来的にGit統合やチーム開発を学びたい場合は、プロジェクト機能を有効化して試すことができます。

## トラブルシューティング

### フロータブが削除できない

- 最後の1つのフロータブは削除できません
- 新しいフローを追加してから削除してください

### デプロイしても変更が反映されない

1. ブラウザをリロード（Ctrl+R / Cmd+R）
2. コンテナログを確認：
   ```bash
   cd docker
   docker compose logs -f nodered
   ```
3. コンテナを再起動：
   ```bash
   ./scripts/stop.sh
   ./scripts/start.sh
   ```

### 変更が消えた

- デプロイしていない変更はブラウザをリロードすると消えます
- バックアップファイル `.flows.json.backup` から復旧できる場合があります

## 参考資料

- [Node-RED公式ドキュメント](https://nodered.org/docs/)
- [Node-RED日本ユーザー会](https://nodered.jp/)
